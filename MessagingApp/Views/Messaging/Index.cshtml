@model IEnumerable<MessagingApp.Models.Message>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var userNames = ViewBag.UserNames as Dictionary<int, string>;
    int loggedInUserId = int.Parse(User.FindFirst("UserId").Value);
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Messaging - MessagingApp</title>
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body>
    <div class="message-container">
        <h1>Messaging with @ViewBag.StudentName</h1>
        <div class="message-list" id="messageList">
            @if (Model != null && Model.Any())
            {
                foreach (var message in Model)
                {
                    bool isSentByUser = message.SenderId == loggedInUserId;
                    <div class="message-wrapper @(isSentByUser ? "sent" : "received")">
                        <small class="message-info">
                            @(userNames.ContainsKey(message.SenderId) ? userNames[message.SenderId] : "Unknown")
                            - @message.Timestamp.ToShortTimeString()
                        </small>
                        <div class="message @(isSentByUser ? "sent-message" : "received-message")">
                            @message.Content
                        </div>
                    </div>
                }
            }
            else
            {
                <p>No messages available.</p>
            }
        </div>
        <form class="add-message-form" method="post" asp-action="AddMessage" asp-controller="Messaging">
            @Html.AntiForgeryToken()
            <input type="hidden" name="studentId" value="@ViewBag.StudentId" />
            <input type="hidden" name="studentName" value="@ViewBag.StudentName" />
            <input type="hidden" name="conversationId" value="@ViewBag.ConversationId" />
            <input type="text" name="content" placeholder="Type your message here..." required />
            <button type="submit">Send</button>
        </form>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var messageList = document.getElementById("messageList");
            messageList.scrollTop = messageList.scrollHeight;
        });
    </script>
</body>
</html>
